<script>
    var languages = null;
</script>
<div class="row">
    <div class="d-none d-xl-block col-0 col-xl-4">
        <ka-include src="/elements/page-list.html"></ka-include>
    </div>

    <div class="col-12 col-xl-8">
        <ka-tpl class="clearfix" wait="page:dataLoaded@page-edit">
            <h4 class="float-start ">
                <i class="bi bi-file-earmark-post fs-1 me-3"></i>
                <span kap:textContent="$event.detail.pid"></span>
                <span kap:textContent="$event.detail.lang" class="badge bg-light border text-dark p-1"></span>
            </h4>

            <div class="dropdown float-end">
                <a class="btn btn-outline-dark dropdown-toggle" href="#" role="button" id="langSelect" data-bs-toggle="dropdown" aria-expanded="false">
                    Sprache: <span kap:textContent="$event.detail.lang"></span>
                </a>
                <ul class="dropdown-menu" aria-labelledby="langSelect">
                    <li ka:for="let lang of $event.detail.languages"><a class="dropdown-item" kap:classlist:active="lang.lang === $event.detail.lang" kap:attr:href="`?pid=${$event.detail.pid}&lang=${lang.lang}`" kap:textContent="lang.name"></a></li>

                </ul>
            </div>
        </ka-tpl>
        <div class="clearfix mb-4 w-100"></div>
        <page-edit></page-edit>
    </div>

</div>
<script type="module">
    import {CodeJar} from 'https://medv.io/codejar/codejar.js'
</script>


<template id="languageListTpl">
    <div ka:if="isExisting === false" class="alert alert-primary">
        Diese Seite existiert noch nicht. Mit Klick auf Speichern wird diese anglegt.
    </div>
    <div ka:for="let curForm of forms" class="mt-2 row">

            <div class="col-4 col-lg-3"><label class="col-form-label" kap:textContent="curForm.name"></label></div>
            <div class="col-7 col-lg-8">
                <input ka:if="curForm.type == 'text'"
                       kap:attr="curForm.attrs" class="form-control"
                       kap:bind="page[curForm.key]">


                <div ka:if="curForm.type == 'switch'" class="form-check form-switch">
                    <label class="form-check-label mt-2 mb-2">
                        <input kap:bind="page[curForm.key]" type="checkbox" class="form-check-input" >
                        <span kap:textContent="curForm.checklabel"></span>
                    </label>
                </div>

                <div ka:if="curForm.type == 'multi'" class="form-check">
                    <label ka:for="let opt of curForm.options" class="form-check-label mt-1">
                        <input kap:bindarray="page[curForm.key]" kap:value="opt.key" type="checkbox" class="form-check-input" >
                        <span kap:textContent="opt.text"></span>
                    </label>
                </div>
                <span kap:textContent="curForm.desc " class="text-muted small"></span>
            </div>
            <div class="col-1 col-lg-1 text-center">
                <i ka:if="curForm.title != null" class="bi bi-info-circle fs-3" data-bs-toggle="tooltip" kap:attr:title="curForm.title"></i>
            </div>
        </div>
    </div>
    <pre id="editor1" kap:textContent="page.content" class="w-100 border bg-light mt-4 p-3" style=" font-size: 16px">
    </pre>





    <nav class="navbar fixed-bottom navbar-light bg-light">
        <div class="container text-end">
            <button class="btn btn-primary ms-auto" kap:on:click="$fn.save()"><i class="bi bi-cloud-arrow-up"></i> Speichern</button>
        </div>
    </nav>

</template>


<script type="module">
import {CodeJar} from 'https://medv.io/codejar/codejar.js'



    function getDefaultSet (section) {
        let defaultForms = [
            {key: "pid", name: "Page-Id", type: "text", attrs: {disabled: true}},
            {key: "lang", name: "Sprache", type: "text", attrs: {disabled: true}},
            {key: "layout", name: "Layout", type: "text", attrs: {disabled: true}},
            {key: "published", name: "", type: "switch", checklabel: "Diese Seite veröffentlichen"},
            {key: "permalink", name: "Perma-Link", type: "text", attrs: {disabled: false},
                desc: "Bitte freilassen, wenn links automatisch angelegt werden sollen."
            },
            {key: "title", name: "Seiten-Titel", type: "text", attrs: {disabled: false},
                title: "Festen Link angeben: Bitte freilassen, wenn Links automatisch angelegt werden sollen."},
            {key: "description", name: "Kurzbeschreibung", type: "text", attrs: {disabled: false, maxlength: 160},
                title: "Kurzbeschreibung: So erscheint Ihre Website in den Suchergebnissen. (Max. 160 Zeichen)"},

        ];
        if (section.is_sortable === true)
            defaultForms.push({key: "order", name: "Sortierung", type: "text", attrs: {disabled: false, type:"number"},
                    title: "Kleinere Werte werden zuerst angezeigt (Nur für Listen)"});
        if (typeof section.ptags !== "undefined" && section.ptags.length > 0)
            defaultForms.push({key: "ptags", name: "Page-Tags", type: "multi", options: section.ptags,
                    title: "Optionen, wie die Seite angezeigt wird"}
            );
        return defaultForms;
    }


    ka_define("page-edit", async(self, tpl) => {
        let pid = KaToolsV1.route.search.get("pid");
        let lang = KaToolsV1.route.search.get("lang");
        let sec = pid.split("/")[0];
        let page =  await api_call("pages/" + pid + "?lang=" + lang);
        let section =  await api_call(`files/${sec}/_section.yml`);
        let languages = await api_call(`files/_data/languages.yml`);



        self.dispatchEvent(new CustomEvent("page:dataLoaded", {
            detail: {
                lang: lang,
                pid: pid,
                languages: languages
            }
        }));

        console.log(page);
        let isExisting = true;

        // New site
        if (typeof page.error !== "undefined") {
            isExisting = false;
            page = {
                pid: pid,
                lang: lang,
                published: false,
                ptags: []
            }
            if (typeof section.defaults !== undefined)
                page = {...page, ...section.defaults}
        }

        let forms = getDefaultSet(section);
        if (Array.isArray(section.forms))
            section.forms.forEach(el => forms.push(el));


        let scope = {
            isExisting: isExisting,
            page: page,
            section: section,
            forms: forms,
            $fn: {

                save: () => {
                    api_call(`pages/_data/${pid}?lang=${lang}`, "POST", page);
                }
            }
        }

        tpl.render(scope);

        //await KaToolsV1.debounce(500, 500);

        const highlight = (editor) => {
          const code = editor.textContent
          // Do something with code and set html.
          editor.innerHTML = code
        }
        let jar = CodeJar(self.querySelector("#editor1"), highlight);
        jar.onUpdate(code => scope.page.content = code)



    }, '#languageListTpl');


</script>

